
import Head from 'next/head';
import { AutodeskForgeViewer } from "../components/AutodeskViewer";

import styles from './home.modules.scss';

// import { ServerSideProps } from 'next';
// import axios from 'axios';

// import config from '../../config';





// type Token = {
//   access_token: string;
//   token_type: string;
//   expires_in: string;
// }

// type HomeProps = { 
//   // autodeskForgeToken: Token[];
// }

//     initializeViewer()

// const Home: React.FC = ({ autodeskForgeToken }: HomeProps) => {
const Home: React.FC = () => {

  return(
    <div>
      <Head>
        <link 
          rel="stylesheet" 
          href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" 
          type="text/css" 
        />
        <script 
          type="text/javascript" 
          src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js" 
        />
      </Head>

      {/* <p>{autodeskForgeToken.access_token}</p>
      <p>{autodeskForgeToken.token_type}</p>
      <p>{autodeskForgeToken.expires_in}</p> */}
      {/* <AutodeskViewer /> */}

       <div>
            <div id='viewerContainer'></div>
        </div>
     </div>

  );
}

export default Home;



export const getServerSideProps: GetServerSideProps = async () => {

    initializeViewer()


  // const autodeskForgeToken = await getAutodeskForgeToken(
  //                                     config.credentials.client_id, 
  //                                     config.credentials.client_secret,
  //                                     'client_credentials',
  //                                     'data:read'
  // );

	  // console.log(`D A T A  : ${JSON.stringify(autodeskForgeToken)}`)

  return {
    props: {
      // autodeskForgeToken
    }
  }

}

const getAutodeskForgeToken = async (client_id, client_secret, grant_type, scope) => {

  const body = `client_id=${client_id}&client_secret=${client_secret}&grant_type=${grant_type}&scope=${scope}`;

  const { data } = await axios.request({
    url: '/authentication/v1/authenticate',
    method: 'post', // default
    baseURL: 'https://developer.api.autodesk.com/',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    data: body    
  })
    
  return data;
}



const initializeViewer = async () => {


  const autodeskForgeToken = await getAutodeskForgeToken(
                                      config.credentials.client_id, 
                                      config.credentials.client_secret,
                                      'client_credentials',
                                      'data:read'
  );

	console.log(`D A T A  : ${JSON.stringify(autodeskForgeToken)}`)

  const token = autodeskForgeToken.access_token;

  const urn ='YWRzay5vYmplY3RzOm9zLm9iamVjdDphdmZxcGF6bGt0MW0xMHBicWRjaHRwa3pwZWlxdGt3dy1pbXQvaW10XzAwXzAxLnJ2dA'


  const viewerOptions = {
      env: 'AutodeskProduction',
      accessToken: token,
      api: 'derivativeV2',
  };
  var viewerContainer = document.getElementById('viewerContainer')
  var viewer = new Autodesk.Viewing.Private.GuiViewer3D(viewerContainer, {})

  Autodesk.Viewing.Initializer(viewerOptions, () => {
      viewer.start();
      Autodesk.Viewing.Document.load(`urn:${urn}`, (doc) =>{
          var defaultModel = doc.getRoot().getDefaultGeometry();
          viewer.loadDocumentNode(doc, defaultModel);
      })
    })
}